<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>VLD Staking v1.07</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root{--bg:#0b1120;--card:#0f172a;--text:#d0d0d0;--muted:#94a3b8;--primary:#3b82f6;--warn:#facc15;--error:#f87171;--ok:#22c55e}
  *{box-sizing:border-box} body{font-family:'Roboto',sans-serif;background-color:var(--bg);color:var(--text);margin:0;padding:2rem}
  h1{font-size:2rem;margin:0 0 1rem;text-align:center}
  .topbar{display:flex;justify-content:space-between;gap:.5rem;align-items:center;margin-bottom:1rem}
  button{background:var(--primary);color:#fff;border:none;padding:.6rem 1rem;border-radius:10px;font-weight:bold;cursor:pointer;transition:opacity .2s}
  button:disabled{opacity:.6;cursor:not-allowed}
  input[type="number"]{padding:.6rem;border-radius:10px;border:1px solid #334155;background:#0b1328;color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
  .card{background:var(--card);border-radius:16px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .muted{color:var(--muted)} .note{color:var(--warn)} .error{color:var(--error);font-weight:700} .ok{color:var(--ok);font-weight:700}
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .badge{padding:.2rem .5rem;border:1px solid #334155;border-radius:999px;font-size:.85rem}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;word-break:break-all}
  .small{font-size:.9rem}
</style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <button id="connect">üîó Connetti Wallet</button>
      <span id="net" class="badge muted">Rete: ‚Äî</span>
    </div>
    <div class="row small">
      <span id="addr" class="mono"></span>
    </div>
  </div>

  <h1>VLD Staking Interface 1.07</h1>

  <div class="grid">
    <div class="card">
      <h3>ü™ô Stake</h3>
      <div class="row" style="margin:.25rem 0 .5rem">
        <input id="amount" placeholder="Quantit√† VLD" type="number" min="0" step="any"/>
        <button id="maxBtn">MAX</button>
        <button id="stake">Stake</button>
      </div>
      <p class="muted" id="user-balance"></p>
      <p class="muted" id="user-staked"></p>
      <p class="muted" id="tvl"></p>
      <p class="note" id="lock-apy"></p>
      <p class="error" id="warning"></p>
      <p class="ok" id="funded" style="display:none"></p>
    </div>

    <div class="card">
      <h3>üéÅ Reward</h3>
      <div class="row" style="margin:.25rem 0 .5rem">
        <button id="claim">Claim</button>
      </div>
      <p class="muted" id="pending-reward"></p>
      <p class="muted" id="last-claim"></p>
      <p class="muted" id="est-next-claim"></p>
    </div>

    <div class="card">
      <h3>üîì Unstake</h3>
      <div class="row" style="margin:.25rem 0 .5rem">
        <button id="unstake" disabled>Unstake</button>
      </div>
      <p class="muted" id="unstake-info"></p>
    </div>
  </div>

<script>
// ===== addresses (aggiorna se diversi) =====
const contractAddress = "0x9AA246af0B01D51D5a9e59c1DdECa6544B8A0198";
const tokenAddress    = "0xDF9387A2BF55F1e5b9f60599b6Ccbf6a5dA13A4b";

// ===== ABIs in linea con il sorgente fornito =====
const abi = [
  "function vldToken() view returns (address)",
  "function owner() view returns (address)",
  "function aprBasisPoints() view returns (uint256)",
  "function lockPeriod() view returns (uint256)",
  "function totalStaked() view returns (uint256)",
  "function stakes(address) view returns (uint256 amount, uint256 startTime, uint256 lastClaim)",
  "function getPendingReward(address) view returns (uint256)",
  "function stake(uint256 amount)",
  "function claimReward()",
  "function unstake()",
  "function fundContract(uint256 amount)",
  "function setApr(uint256 newAprBasisPoints)",
  "function setLockPeriod(uint256 newLock)",
  "function recoverTokens(address tokenAddress,uint256 amount)"
];
const tokenAbi = [
  "function approve(address spender, uint256 amount) returns (bool)",
  "function balanceOf(address account) view returns (uint256)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

let provider, signer, userAddress, staking, token, tokenDecimals=18, symbol="VLD";

function fmt(bn,dec=tokenDecimals){ try{return ethers.utils.formatUnits(bn,dec)}catch{return String(bn)} }

async function ensureBSC(){
  const net = await provider.getNetwork();
  document.getElementById('net').innerText = `Rete: ${net.name} (${net.chainId})`;
  if (net.chainId !== 56){
    try{
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }]});
      document.getElementById('net').innerText = "Rete: BSC (56)";
    }catch(e){
      try{
        await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{
          chainId:"0x38", chainName:"BNB Smart Chain",
          nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
          rpcUrls:["https://bsc-dataseed.binance.org/"], blockExplorerUrls:["https://bscscan.com/"]
        }]});
        document.getElementById('net').innerText = "Rete: BSC (56)";
      }catch(err){
        alert("Seleziona manualmente la rete BSC su MetaMask e riconnetti.");
      }
    }
  }
}

async function refresh(){
  if(!staking || !token || !userAddress) return;
  try{
    const [bal, st, lp, aprBP, tvl, pending, rewardFund] = await Promise.all([
      token.balanceOf(userAddress),
      staking.stakes(userAddress),
      staking.lockPeriod(),
      staking.aprBasisPoints(),
      staking.totalStaked(),
      staking.getPendingReward(userAddress),
      token.balanceOf(contractAddress)
    ]);

    // tuple tolerant
    const amount    = st.amount ?? st[0] ?? ethers.constants.Zero;
    const startTime = st.startTime ?? st[1] ?? ethers.constants.Zero;
    const lastClaim = st.lastClaim ?? st[2] ?? ethers.constants.Zero;

    document.getElementById("user-balance").innerText = `Saldo: ${fmt(bal)} ${symbol}`;
    document.getElementById("user-staked").innerText  = `In staking: ${fmt(amount)} ${symbol}`;
    document.getElementById("tvl").innerText          = `TVL: ${fmt(tvl)} ${symbol}`;

    const apr = Number(aprBP)/100;
    const days = Math.floor(Number(lp)/86400);
    document.getElementById("lock-apy").innerText = `‚è≥ Lock: ${days} giorni ‚Äî APR: ${apr.toFixed(2)}%`;

    document.getElementById("pending-reward").innerText = `Reward maturata: ${fmt(pending)} ${symbol}`;
    const lc = Number(lastClaim);
    document.getElementById("last-claim").innerText = lc>0 ? `Ultimo claim: ${new Date(lc*1000).toLocaleString()}` : "Ultimo claim: ‚Äî";

    // unstake gating
    const now = Math.floor(Date.now()/1000);
    const unlockTime = Number(startTime) + Number(lp);
    const unstakeBtn = document.getElementById("unstake");
    const ui = document.getElementById("unstake-info");
    if (ethers.BigNumber.from(amount).isZero()){
      ui.innerText = "Nessun importo in staking.";
      unstakeBtn.disabled = true;
      document.getElementById("est-next-claim").innerText = "";
    } else if (now < unlockTime){
      ui.innerText = "Unstake dal: " + new Date(unlockTime*1000).toLocaleString();
      unstakeBtn.disabled = true;
      document.getElementById("est-next-claim").innerText = "Prossimo claim stimato: continuo (proporzionale al tempo)";
    } else {
      ui.innerText = "Puoi fare unstake ora.";
      unstakeBtn.disabled = false;
      document.getElementById("est-next-claim").innerText = "Prossimo claim: immediato";
    }

    // reward fund warning
    if (rewardFund.eq(0)){
      document.getElementById("warning").innerText = "‚ö†Ô∏è Contratto non finanziato per i reward.";
      document.getElementById("funded").style.display="none";
    } else {
      const f = document.getElementById("funded");
      f.style.display="block";
      f.innerText = `Fondi reward nel contratto: ${fmt(rewardFund)} ${symbol}`;
      document.getElementById("warning").innerText = "";
    }
  }catch(e){
    console.error(e);
  }
}

document.getElementById("connect").onclick = async () => {
  try{
    if(!window.ethereum) return alert("Installa MetaMask");
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    await ensureBSC();
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    document.getElementById("addr").innerText = "Wallet: " + userAddress;

    staking = new ethers.Contract(contractAddress, abi, signer);
    token   = new ethers.Contract(tokenAddress, tokenAbi, signer);
    try{ tokenDecimals = await token.decimals(); }catch{ tokenDecimals = 18; }
    try{ symbol = await token.symbol(); }catch{ symbol = "VLD"; }

    await refresh();
    if (window.ethereum){
      window.ethereum.on('chainChanged', ()=>location.reload());
      window.ethereum.on('accountsChanged', ()=>location.reload());
    }
    // auto refresh
    setInterval(refresh, 20000);
  }catch(e){
    alert("Errore wallet: " + (e?.message||e));
  }
};

document.getElementById("maxBtn").onclick = async () => {
  if(!token||!userAddress) return;
  const bal = await token.balanceOf(userAddress);
  document.getElementById("amount").value = ethers.utils.formatUnits(bal, tokenDecimals);
};

async function txWithGas(fn, args=[]){
  let gas; try{ gas = await fn.estimateGas(...args);}catch{}
  const opts = gas ? { gasLimit: gas.mul(115).div(100) } : {};
  const tx = await fn(...args, opts); await tx.wait();
}

document.getElementById("stake").onclick = async () => {
  try{
    const amtStr = (document.getElementById("amount").value||"").trim();
    if (!amtStr) return alert("Inserisci un importo");
    const amount = ethers.utils.parseUnits(amtStr, tokenDecimals);
    const bal = await token.balanceOf(userAddress);
    if (bal.lt(amount)) return alert("Saldo insufficiente");
    const allowance = await token.allowance(userAddress, contractAddress);
    if (allowance.lt(amount)){
      const txA = await token.approve(contractAddress, ethers.constants.MaxUint256);
      await txA.wait();
    }
    await txWithGas(staking.stake, [amount]);
    alert("Stake eseguito!");
    document.getElementById("amount").value = "";
    await refresh();
  }catch(e){ alert("Errore stake: " + (e?.message||e)); }
};

document.getElementById("claim").onclick = async () => {
  try{ await txWithGas(staking.claimReward, []); alert("Reward ricevuta!"); await refresh(); }
  catch(e){ alert("Errore claim: " + (e?.message||e)); }
};

document.getElementById("unstake").onclick = async () => {
  try{ await txWithGas(staking.unstake, []); alert("Unstake completato!"); await refresh(); }
  catch(e){ alert("Errore unstake: " + (e?.message||e)); }
};
</script>
</body>
</html>

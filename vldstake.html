<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>VLD Staking 1.0 (Unlock + i18n, no-estimateGas)</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background-color: #0b1120;
    color: #d0d0d0;
    margin: 0;
    padding: 2rem 1rem;
    text-align: center;
  }
  .wrap { max-width:880px; margin:0 auto; }
  .topbar{ display:flex; justify-content:space-between; align-items:center; max-width:880px; margin:0 auto 1rem }
  .lang{ display:flex; gap:.5rem }
  h1 { font-size: 2rem; margin: .25rem 0 1rem; }
  button {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 0.65rem 1.1rem;
    margin: 0.25rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  button:disabled { opacity:.6; cursor:not-allowed }
  input[type="number"] {
    padding: 0.55rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #334155;
    margin-right: 0.5rem;
    background:#0e1a33;
    color:#d0d0d0;
  }
  .section { margin-top: 1.5rem; }
  #account { margin-top: .5rem; font-style: italic; color: #94a3b8; word-break: break-all; }
  .note { color: #facc15; font-size: 0.95rem; margin-top: 0.5rem; }
</style>
</head>
<body>
  <div class="topbar">
    <div>
      <button id="connect" data-i18n="connect">üîó Connetti Wallet</button>
    </div>
    <div class="lang">
      <button id="btn-it">ITA</button>
      <button id="btn-en">ENG</button>
    </div>
  </div>

  <div class="wrap">
    <h1 data-i18n="title">VLD Staking 1.0 (Unlock + i18n, no-estimateGas)</h1>

    <p id="account"></p>

    <div class="section">
      <h3 data-i18n="stake_title">ü™ô Fai stake dei tuoi VLD</h3>
      <input id="amount" placeholder="Quantit√† VLD" type="number" step="any"/>
      <button id="stake" data-i18n="stake_btn">Stake</button>
      <p class="note" id="user-balance"></p>
      <p class="note" id="user-staked"></p>
    </div>

    <div class="section">
      <h3 data-i18n="claim_title">üéÅ Claim reward</h3>
      <button id="claim" data-i18n="claim_btn">Claim</button>
    </div>

    <div class="section">
      <h3 data-i18n="unstake_title">üîì Unstake</h3>
      <button id="unstake" data-i18n="unstake_btn" disabled>Unstake</button>
      <p class="note" id="unstake-info"></p>
    </div>
  </div>

<script>
// === Addresses (aggiorna se diversi) ===
const contractAddress = "0x9AA246af0B01D51D5a9e59c1DdECa6544B8A0198"; // Staking
const tokenAddress    = "0xDF9387A2BF55F1e5b9f60599b6Ccbf6a5dA13A4b"; // VLD

// === Minimal ABI (come l'originale, pi√π funzioni per unlock) ===
const stakingAbi = [
  "function stake(uint256 amount)",
  "function claimReward()",
  "function unstake()",
  "function stakes(address) view returns (uint256 amount, uint256 startTime, uint256 lastClaim)",
  "function lockPeriod() view returns (uint256)"
];
const tokenAbi = [
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address owner,address spender) view returns (uint256)",
  "function approve(address spender,uint256 amount) returns (bool)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];

// === i18n ===
const translations = {
  it: {
    title:"VLD Staking 1.0 (Unlock + i18n, no-estimateGas)",
    connect:"üîó Connetti Wallet",
    wallet:"Wallet: ",
    stake_title:"ü™ô Fai stake dei tuoi VLD",
    stake_btn:"Stake",
    claim_title:"üéÅ Claim reward",
    claim_btn:"Claim",
    unstake_title:"üîì Unstake",
    unstake_btn:"Unstake",
    balance:"Saldo VLD",
    staked:"In staking",
    none_staked:"Nessun importo in staking.",
    unstake_from:"Unstake disponibile dal: ",
    unstake_now:"‚úÖ Puoi fare unstake ora.",
    enter_amount:"Inserisci un importo valido.",
    need_metamask:"Installa MetaMask per continuare.",
    stake_done:"Stake eseguito!",
    claim_done:"Reward ricevuta!",
    unstake_done:"Unstake completato!",
    err_wallet:"Errore nella connessione al wallet.",
    err_stake:"Errore durante lo stake.",
    err_claim:"Errore durante il claim.",
    err_unstake:"Errore durante l'unstake.",
    insufficient:"Saldo insufficiente."
  },
  en: {
    title:"VLD Staking 1.0 (Unlock + i18n, no-estimateGas)",
    connect:"üîó Connect Wallet",
    wallet:"Wallet: ",
    stake_title:"ü™ô Stake your VLD",
    stake_btn:"Stake",
    claim_title:"üéÅ Claim reward",
    claim_btn:"Claim",
    unstake_title:"üîì Unstake",
    unstake_btn:"Unstake",
    balance:"VLD Balance",
    staked:"Staked",
    none_staked:"No amount staked.",
    unstake_from:"Unstake available from: ",
    unstake_now:"‚úÖ You can unstake now.",
    enter_amount:"Please enter a valid amount.",
    need_metamask:"Install MetaMask to continue.",
    stake_done:"Stake successful!",
    claim_done:"Reward claimed!",
    unstake_done:"Unstake completed!",
    err_wallet:"Error connecting to wallet.",
    err_stake:"Error during stake.",
    err_claim:"Error during claim.",
    err_unstake:"Error during unstake.",
    insufficient:"Insufficient balance."
  }
};

let currentLang = localStorage.getItem("vld_lang") || "it";
function t(k){ return translations[currentLang][k] || k; }
function applyStaticTexts(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if (translations[currentLang][key]) el.innerText = translations[currentLang][key];
  });
}

// === Web3 state ===
let provider, signer, staking, token, user, tokenDecimals = 18, symbol = "VLD";

function fmt(bn){ try{ return ethers.utils.formatUnits(bn, tokenDecimals); }catch{return String(bn);} }

async function ensureBSC(){
  const net = await provider.getNetwork();
  if (net.chainId !== 56){
    try {
      await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x38" }]});
    } catch (e) {
      try {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId:"0x38",
            chainName:"BNB Smart Chain",
            nativeCurrency:{ name:"BNB", symbol:"BNB", decimals:18 },
            rpcUrls:["https://bsc-dataseed.binance.org/"],
            blockExplorerUrls:["https://bscscan.com/"]
          }]
        });
      } catch (err) {
        alert("Seleziona manualmente la rete BSC in MetaMask.");
      }
    }
  }
}

async function refresh(){
  if (!staking || !token || !user) return;
  try{
    const [bal, st, lp] = await Promise.all([
      token.balanceOf(user),
      staking.stakes(user),
      staking.lockPeriod()
    ]);

    const amount    = st.amount ?? st[0] ?? ethers.constants.Zero;
    const startTime = st.startTime ?? st[1] ?? ethers.constants.Zero;

    document.getElementById("user-balance").innerText = `${t('balance')}: ${fmt(bal)} ${symbol}`;
    document.getElementById("user-staked").innerText  = `${t('staked')}: ${fmt(amount)} ${symbol}`;

    const unstakeBtn = document.getElementById("unstake");
    const ui = document.getElementById("unstake-info");

    if (ethers.BigNumber.from(amount).isZero()){
      ui.innerText = t('none_staked');
      unstakeBtn.disabled = true;
    } else {
      const block = await signer.provider.getBlock("latest");
      const now = block.timestamp;
      const unlockTime = Number(startTime) + Number(lp);
      if (now < unlockTime){
        ui.innerText = t('unstake_from') + new Date(unlockTime * 1000).toLocaleString();
        unstakeBtn.disabled = true;
      } else {
        ui.innerText = t('unstake_now');
        unstakeBtn.disabled = false;
      }
    }
  }catch(e){
    console.error("refresh error", e);
  }
}

// === Event handlers ===
document.getElementById("btn-it").onclick = ()=>{ currentLang="it"; localStorage.setItem("vld_lang","it"); applyStaticTexts(); refresh(); };
document.getElementById("btn-en").onclick = ()=>{ currentLang="en"; localStorage.setItem("vld_lang","en"); applyStaticTexts(); refresh(); };

document.getElementById("connect").onclick = async () => {
  try{
    if (!window.ethereum) return alert(t('need_metamask'));
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    await ensureBSC();
    signer = provider.getSigner();
    user = await signer.getAddress();
    document.getElementById("account").innerText = t('wallet') + user;

    staking = new ethers.Contract(contractAddress, stakingAbi, signer);
    token   = new ethers.Contract(tokenAddress, tokenAbi, signer);
    try { tokenDecimals = await token.decimals(); } catch { tokenDecimals = 18; }
    try { symbol = await token.symbol(); } catch { symbol = "VLD"; }

    await refresh();
    setInterval(refresh, 20000);
  }catch(e){
    console.error(e);
    alert(t('err_wallet'));
  }
};

// === NO estimateGas anywhere (faithful to original behavior) ===
document.getElementById("stake").onclick = async () => {
  try{
    const v = (document.getElementById("amount").value || "").trim();
    if (!v) return alert(t('enter_amount'));
    const amount = ethers.utils.parseUnits(v.replace(",", "."), tokenDecimals);

    const bal = await token.balanceOf(user);
    if (bal.lt(amount)) return alert(t('insufficient'));

    const allowance = await token.allowance(user, contractAddress);
    if (allowance.lt(amount)){
      const txA = await token.approve(contractAddress, ethers.constants.MaxUint256);
      await txA.wait();
      // extra micro delay to avoid flaky RPCs
      await new Promise(r => setTimeout(r, 500));
    }

    // Direct call, no estimateGas
    const tx = await staking.stake(amount);
    await tx.wait();

    alert(t('stake_done'));
    document.getElementById("amount").value = "";
    await refresh();
  }catch(e){
    console.error(e);
    alert(t('err_stake'));
  }
};

document.getElementById("claim").onclick = async () => {
  try{
    const tx = await staking.claimReward();
    await tx.wait();
    alert(t('claim_done'));
    await refresh();
  }catch(e){
    console.error(e);
    alert(t('err_claim'));
  }
};

document.getElementById("unstake").onclick = async () => {
  try{
    const tx = await staking.unstake();
    await tx.wait();
    alert(t('unstake_done'));
    await refresh();
  }catch(e){
    console.error(e);
    alert(t('err_unstake'));
  }
};

// init i18n
applyStaticTexts();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validora – File Certifier dApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b1120; --panel: #111827; --muted: #9ca3af; --text: #e5e7eb;
      --accent: #3b82f6; --accent-2: #22c55e; --warn: #f59e0b; --error: #ef4444; --border: #1f2937; --card: #0f172a;
    }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 800px at 100% -10%, #111827 0%, var(--bg) 40%); color: var(--text); }
    h1 { font-size: 28px; margin: 0 0 4px; }
    .sub { color: var(--muted); margin-bottom: 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .spaced { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button { background: var(--accent); border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    button.warn { background: var(--warn); }
    button.success { background: var(--accent-2); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input { width: 100%; background: var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px; color: var(--text); }
    label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .log { background:#0a0f1f; border:1px solid var(--border); border-radius:12px; padding:10px; font-size:12px; white-space:pre-wrap; max-height:220px; overflow:auto; }
    .banner { border:1px dashed var(--warn); background: rgba(245,158,11,.08); color:#fde68a; padding:8px 12px; border-radius:12px; margin: 8px 0 16px; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header class="spaced">
    <div>
      <h1 data-i18n="title">Validora – File Certifier</h1>
      <div class="sub" data-i18n="subtitle">Certify your file's keccak256 hash on BSC using VLD.</div>
    </div>
    <div class="btns">
      <button id="btn-lang-en" class="secondary">EN</button>
      <button id="btn-lang-it" class="secondary">IT</button>
      <button id="btn-connect" data-i18n="connect">Connect Wallet</button>
      <button id="btn-disconnect" class="secondary" data-i18n="disconnect" disabled>Disconnect</button>
    </div>
  </header>

  <div id="net-banner" class="banner" style="display:none;"></div>

  <!-- Single certify -->
  <section class="card">
    <h2 style="margin-top:0" data-i18n="singleTitle">Single file certification</h2>
    <div class="row">
      <div>
        <label data-i18n="fileLabel">Select file</label>
        <input id="file-input" type="file" />
      </div>
      <div>
        <label data-i18n="uriLabel">URI (optional)</label>
        <input id="uri-input" placeholder="ipfs://..." />
      </div>
    </div>
    <div class="row" style="margin-top:12px;">
      <div>
        <label data-i18n="hashLabel">Hash (keccak256)</label>
        <input id="hash-out" class="mono" readonly />
      </div>
      <div>
        <label data-i18n="sizeLabel">Size (bytes)</label>
        <input id="size-out" class="mono" readonly />
      </div>
    </div>
    <div class="row" style="margin-top:12px;align-items:end;">
      <div>
        <label data-i18n="feeLabel">Estimated fee (VLD)</label>
        <input id="fee-out" class="mono" readonly />
      </div>
      <div class="btns">
        <button id="btn-quote" class="secondary" data-i18n="btnQuote">Calculate Fee</button>
        <button id="btn-approve" class="warn" disabled data-i18n="btnApprove">Approve VLD</button>
        <button id="btn-certify" class="success" disabled data-i18n="btnCertify">Certify</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px;" data-i18n="privacyNote">Hashes are computed locally in your browser.</div>
  </section>

  <section class="card" style="margin-top:16px;">
    <h3 style="margin-top:0;" data-i18n="logTitle">Log</h3>
    <div id="log" class="log"></div>
  </section>

<script>
(function(){
  const { ethers } = window.ethers;

  // ==== Fixed configuration (hidden) ====
  const CFG = {
    chainId: 97, // BSC Testnet
    fileCert: "0x32B0A57C00FCD8B0334a28F5E571037e205369dc", // FileCertifier on testnet
    vld: "0xD6B7DA76B70875f0959aFb20467cD991D89Cf89b" // VLD on testnet
  };

  // ==== i18n ====
  const I18N = {
    en: {
      title:"Validora – File Certifier",
      subtitle:"Certify your file's keccak256 hash on BSC using VLD.",
      connect:"Connect Wallet", disconnect:"Disconnect",
      networkWarn:"You're not on BSC Testnet (97). Please switch network in Metamask.",
      singleTitle:"Single file certification",
      fileLabel:"Select file", uriLabel:"URI (optional)",
      hashLabel:"Hash (keccak256)", sizeLabel:"Size (bytes)",
      feeLabel:"Estimated fee (VLD)", btnQuote:"Calculate Fee",
      btnApprove:"Approve VLD", btnCertify:"Certify",
      privacyNote:"Hashes are computed locally in your browser.",
      logTitle:"Log",
      noMM:"Metamask not detected",
      needFile:"Select a file first",
      needConnect:"Connect wallet first",
    },
    it: {
      title:"Validora – Certificatore File",
      subtitle:"Certifica l'hash keccak256 del tuo file su BSC usando VLD.",
      connect:"Connetti Wallet", disconnect:"Disconnetti",
      networkWarn:"Non sei su BSC Testnet (97). Cambia rete in Metamask.",
      singleTitle:"Certificazione file singolo",
      fileLabel:"Seleziona file", uriLabel:"URI (opzionale)",
      hashLabel:"Hash (keccak256)", sizeLabel:"Dimensione (byte)",
      feeLabel:"Fee stimata (VLD)", btnQuote:"Calcola Fee",
      btnApprove:"Approva VLD", btnCertify:"Certifica",
      privacyNote:"Gli hash sono calcolati in locale nel tuo browser.",
      logTitle:"Log",
      noMM:"Metamask non rilevato",
      needFile:"Seleziona prima un file",
      needConnect:"Connetti prima il wallet",
    }
  };
  let lang = 'en';

  function t(key){ return (I18N[lang] && I18N[lang][key]) || key; }
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      el.textContent = t(el.getAttribute('data-i18n'));
    });
  }

  // ==== Minimal ABIs ====
  const FILE_CERTIFIER_ABI = [
    "function quoteItem(uint64 size) view returns (uint256)",
    "function certify(bytes32 fileHash, uint64 size, string uri)",
    "function baseFee() view returns (uint256)",
    "function unitFee() view returns (uint256)",
    "function chunkSize() view returns (uint256)",
    "function batchDiscountBps() view returns (uint16)",
  ];
  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];

  // ==== UI & state ====
  const el = id => document.getElementById(id);
  const logEl = el('log');
  function log(msg){ logEl.textContent += msg + " "; logEl.scrollTop = logEl.scrollHeight; }
  function fmt18(bn){ try { return ethers.utils.formatUnits(bn||0, 18); } catch{ return String(bn); } }

  const state = { provider:null, signer:null, account:null, fc:null, vld:null, feeQuote: ethers.constants.Zero, decimals:18, chainId:null };

  function updateButtons(){
    const connected = !!state.account;
    el('btn-connect').disabled = connected;
    el('btn-disconnect').disabled = !connected;
  }

  function showNetWarning(show){
    const banner = document.getElementById('net-banner');
    if (show){ banner.style.display='block'; banner.textContent = t('networkWarn'); }
    else { banner.style.display='none'; banner.textContent=''; }
  }

  async function connect(){
    if (!window.ethereum) { alert(t('noMM')); return; }
    await ethereum.request({ method: 'eth_requestAccounts' });
    state.provider = new ethers.providers.Web3Provider(window.ethereum);
    state.signer = state.provider.getSigner();
    state.account = await state.signer.getAddress();
    const net = await state.provider.getNetwork();
    state.chainId = Number(net.chainId);
    log(`Connected: ${state.account} | chainId ${state.chainId}`);
    updateButtons();

    if (state.chainId !== CFG.chainId){
      showNetWarning(true);
    } else {
      showNetWarning(false);
      await initContracts();
    }
  }
  async function disconnect(){
    state.provider=null; state.signer=null; state.account=null; state.fc=null; state.vld=null; state.feeQuote=ethers.constants.Zero; state.chainId=null;
    updateButtons();
    showNetWarning(false);
    log('Disconnected');
  }

  async function initContracts(){
    state.fc = new ethers.Contract(CFG.fileCert, FILE_CERTIFIER_ABI, state.signer);
    state.vld = new ethers.Contract(CFG.vld, ERC20_ABI, state.signer);
    try { state.decimals = await state.vld.decimals(); } catch{}
  }

  // Helpers
  function toBytes(buffer){ return new Uint8Array(buffer); }
  async function hashFile(file){
    const buf = await file.arrayBuffer();
    const hex = ethers.utils.hexlify(toBytes(buf));
    return ethers.utils.keccak256(hex);
  }
  async function hasAllowance(required){
    const allowance = await state.vld.allowance(state.account, CFG.fileCert);
    return ethers.BigNumber.from(allowance).gte(required);
  }

  // Events
  el('btn-connect').addEventListener('click', connect);
  el('btn-disconnect').addEventListener('click', disconnect);

  el('btn-lang-en').addEventListener('click', ()=>{ lang='en'; applyI18n(); });
  el('btn-lang-it').addEventListener('click', ()=>{ lang='it'; applyI18n(); });

  el('file-input').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    el('size-out').value = String(f.size);
    el('hash-out').value = '...';
    try { const h = await hashFile(f); el('hash-out').value = h; log('Hash: ' + h); } catch(err){ el('hash-out').value=''; log('Hash error: ' + (err.message||err)); }
  });

  el('btn-quote').addEventListener('click', async ()=>{
    if (!state.fc || !state.account) { return alert(t('needConnect')); }
    const size = parseInt(el('size-out').value || '0', 10);
    if (!size) return alert(t('needFile'));
    const fee = await state.fc.quoteItem(size);
    state.feeQuote = fee;
    el('fee-out').value = fmt18(fee);
    const ok = await hasAllowance(fee);
    el('btn-approve').disabled = ok;
    el('btn-certify').disabled = !ok;
    log('Estimated fee: ' + fmt18(fee) + ' VLD');
  });

  el('btn-approve').addEventListener('click', async ()=>{
    if (!state.vld) return alert(t('needConnect'));
    const amount = state.feeQuote; if (!amount || amount.isZero()) return alert('Quote first');
    const tx = await state.vld.approve(CFG.fileCert, amount);
    log('approve tx: ' + tx.hash);
    await tx.wait();
    log('approve confirmed');
    el('btn-approve').disabled = true; el('btn-certify').disabled = false;
  });

  el('btn-certify').addEventListener('click', async ()=>{
    const f = el('file-input').files[0]; if (!f) return alert(t('needFile'));
    const hash = el('hash-out').value; if (!hash) return alert('Missing hash');
    const size = f.size; const uri = (el('uri-input').value || '').trim();
    const tx = await state.fc.certify(hash, size, uri);
    log('certify tx: ' + tx.hash);
    const rc = await tx.wait();
    log('certify confirmed – block ' + rc.blockNumber);
  });

  // Init i18n default EN
  applyI18n();
})();
</script>
</body>
</html>
